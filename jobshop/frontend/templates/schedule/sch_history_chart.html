{% extends "common/header.html" %}
{% block content %}

<!-- Page Heading -->
<div class="row">
    <div class="col-lg-12">
            <div class="panel panel-default">
                <div class="panel-body">
                    <div class="d-sm-flex align-items-center mb-4">
                        <!--<h1 class="h3 mb-0 text-gray-800">작업스케쥴링</h1>-->
                        <div class="col-auto pknu-searchDate">
                            <div class="col-lg-2 col-md-3 pknu-searchDate-dd">
                                <label>주문일자</label>
                            </div>
                            <div class="col-lg-3 col-md-4 pknu-searchDate-dd" >
                                 <input class="form-control text-center" type="text" name="dateFrom" id="dateFrom" />
                            </div>
                            <div class="col-lg-1 col-md-1 pknu-searchDate-dd">~</div>
                            <div class="col-lg-3 col-md-4 pknu-searchDate-dd" style="margin-right:0.4rem;">
                                <input class="form-control text-center" type="text" name="dateTo" id="dateTo" />
                            </div>
                            <div class="col-pos-right">
                                <a id="searchBtn" href="#" class="d-sm-inline-block btn btn-sm btn-primary shadow-sm"><i class="fas fa-search mr-1"></i>검색</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </div>
</div>
<div class="row">
    <div class="col-xl-6 col-lg-5">
        <div class="card shadow mb-4">
            <!-- Card Header - Dropdown -->
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">스케줄 이력 차트 </h6>

            </div>
            <!-- Card Body -->
            <div class="card-body chart-body" >
                <div class="chart-area">
                    <canvas id="myAreaChart"></canvas>
                </div>
            </div>
        </div>
    </div>

</div>
<!-- Area Chart -->


<!-- Scroll to Top Button-->
<a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
</a>
<div id="css-loader" class="loader loader-default"></div>

<script>
    function dateformat(value){
        var year = value.substring(0,4);
        var month = value.substring(4,6);
        var day = value.substring(6,8);
        var date = year + '-' + month + '-' + day;
        return date;
    }
    // 전송 클릭 시 이벤트
    function sendSchedule(){
        Swal.fire({
          icon: 'question',
          title: '스케쥴을 확정하시겠습니까?',
          showDenyButton: true,
          confirmButtonText: '네',
          denyButtonText: `아니오`,
        }).then((result) => {
            if(result.isConfirmed){
                $('#css-loader').addClass("is-active");
                var order = new Array();
                for(var i=0; i<$('.checkbox').length; i++){
                    if($('.checkbox').eq(i).val()=='Y'){
                        order.push($('.checkbox').eq(i).parent().siblings('.sch_id').val());
                    }
                }
                $.ajax({
                    url: "{% url 'fixed_order' %}",
                    method: 'POST',
                    dataType :   "json",
                    contentType :   "application/x-www-form-urlencoded; charset=UTF-8",
                    data:{'order_list[]': order},
                }).done(function(response){
                    $('#css-loader').removeClass("is-active");
                    location.reload();
                })
            }
        });
    }
    // 새로 생성 버튼 클릭 시 이벤트
    function removeSchedule(){
        // 기존의 확정된 스케줄 삭제
        Swal.fire({
          icon: 'question',
          title: '스케쥴을 새로 생성하시겠습니까?',
          showDenyButton: true,
          confirmButtonText: '네',
          denyButtonText: `아니오`,
        }).then((result) => {
            if(result.isConfirmed){
                $('#css-loader').addClass("is-active");
                // var order = new Array();
                var sch = new Array();
                for(var i=0; i<$('.order_id').length; i++){
                    // order.push($('.order_id').eq(i).val());
                    sch.push($('.sch_id').eq(i).val());
                }
                $.ajax({
                    url: "{% url 'delete_order' %}",
                    method: 'POST',
                    dataType :   "json",
                    contentType :   "application/x-www-form-urlencoded; charset=UTF-8",
                    data:{'sch_list[]' : sch},
                }).done(function(response){
                    $('#css-loader').removeClass("is-active");
                    location.reload();
                })

            }
        });
    }

    $(function(){
        $('#availfacnum').on('change', function(){
            var facnum = $('#availfacnum').val();
            var order = $('#selectOrder').val();
            var innerHTML = '<thead>' +
                                '<tr>'+
                                '<th></th>';
            for(var i=1; i<=facnum; i++){
                innerHTML += '<th>machine ' + i + '</th>';
            }
            innerHTML +=    '</tr>' +
                         '</thead>'+
                         '<tbody>';
            for(var i=0; i<order.length; i++){
                innerHTML += '<tr> <td>' + order[i] + '</td>';
                for(var j=1; j<=facnum; j++){
                   innerHTML += '<td><input type="text" style="border:none; width:50px;"/></td>';
                }
                innerHTML += '</tr>';
            }
            $('#dataTable').html(innerHTML);
            $('#processingdataTable').html(innerHTML);
        })





        $("#selectOrder").multipleSelect({
            filter: true
        });

        const today = moment();
        // 검색 날짜 init
        flatpickr("#dateFrom, #dateTo, #estDate, #ordDateFrom, #ordDateTo", {
               locale: Flatpickr.l10ns.ko,
               enableTime: false,
               dateFormat: "Y-m-d",
               disableMobile: true,
               defaultDate: [today.format('YYYY-MM-DD')]
        });

        var ctx = document.getElementById("myAreaChart");
        var chartset = false;
            $.ajax({
                url: "{% url 'draw_graph' %}",
                method:'GET',
                dataType: 'json',
                contentType: 'application/json',
                processData: false,
                success: function(result){
                    var dataset = new Array();
                    for(var i=0; i<result.length; i++){
                        dataset.push({
                            label: result[i].order_id,
                            backgroundColor: "rgba(78, 115, 223, 0.05)",
                            borderColor: result[i].sch_color,
                            fill: false,
                            responsive: true,
                            borderWidth : 15,
                            pointRadius : 0,
                            data: [
                                {
                                    x: result[i].x_axis_1/40,
                                    y: result[i].y_axis_1,
                                }, {
                                    x: result[i].x_axis_2/40,
                                    y: result[i].y_axis_1,
                                }
                            ]
                        })
                    }

                    // chart.js 그리기
                    var scatterChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            datasets: dataset
                        },
                        options: {
                            // y축 빨간선 표시
                            annotation: {
                                annotations: [
                                {
                                    drawTime: "afterDatasetsDraw",
                                    type: "line",
                                    mode: "vertical",
                                    scaleID: "x-axis-0",
                                    value: 26,
                                    borderWidth: 1,
                                    borderColor: "red",
                                    label: {
                                        content: "작업완료기한 : 12월" + 26 + "일",
                                        enabled: true,
                                        position: "top",
                                        backgroundColor: "rgba(160,170,174,100)",
                                    },
                                }
                                ]
                            }, // y축 빨간선 표시
                            animation: {
                                onComplete: function () {
                                    var ctx = this.chart.ctx;
                                    ctx.font = Chart.helpers.fontString(Chart.defaults.global.defaultFontFamily, 'light', Chart.defaults.global.defaultFontFamily);
                                    ctx.fillStyle = "#4e73df";
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'bottom';

                                    this.data.datasets.forEach(function (dataset)
                                    {
                                        for (var i = 0; i < dataset.data.length/2; i++) {
                                            for(var key in dataset._meta)
                                            {
                                                var model = dataset._meta[key].data[i]._model;
                                                var index = dataset._meta[key].controller._config.label.replace('ORD00', '').replace('ORD0', '');
                                                ctx.fillText(index, model.x, model.y);
                                            }
                                        }
                                    });
                                }
                            },
                            legend : {
                                display : false
                            },
                            scales: {
                                xAxes: [{
                                    type: 'linear',
                                    position: 'bottom',
                                    scaleLabel: {
                                        display: false,
                                        labelString: 'x axis'
                                    },
                                    ticks : {
                                        min: 1,
                                        max: 31,
                                        // suggestedMin: 1,
                                        // maxRotation: 0,
                                        stepSize : 1
                                    }
                                }],
                                yAxes : [{
                                    scaleLabel : {
                                        display : false
                                    },
                                    scaleLabel: {
                                        display: false,
                                        labelString: 'y axis'
                                    },
                                    ticks : {
                                        beginAtZero :true,
                                        stepSize : 1,
                                        max : 9
                                    }
                                }]
                            },
                            pan: {
                                enabled: true,
                                mode: 'x',
                            },
                            zoom: {
                                enabled: true,
                                mode: 'x',
                            },
                        },
                    });
            }
        });

        $.ajax({
            url: "{% url 'available_comp' %}",
            method:'GET',
            dataType: 'json',
            contentType: 'application/json',
            processData: false,
            success: function(result){
                $.ajax({
                    url: "{% url 'confirmed_order' %}",
                    method:'GET',
                    dataType: 'json',
                    contentType: 'application/json',
                    processData: false,
                    success: function(data){
                        var innerHTML='';
                        if(data.length>0){
                            for(var i=0; i<data.length; i++){
                                if(data[i].use_yn == 'Y') {
                                    $('#sendSchedule').remove();
                                    $('#sendBtn').html('<a href="#" onclick="removeSchedule()" id="removeSchedule"' +
                                                        'class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm">' +
                                                        '<i class="fas fa-plus-square"></i>&nbsp 초기화</a>');
                                    console.log(result[i].schedule[0].order_id.toString());
                                    /* 추후 삭제 */
                                    var orderid = result[i].schedule[0].order_id.toString();
                                    /* 추후 삭제 */

                                    var date = result[i].schedule[0].sch_id.toString()
                                    var year = date.substring(3,7);
                                    var month = date.substring(7,9);
                                    var day = date.substring(9,11);
                                    date = year + '-' + month + '-' + day;
                                    var count = i+1;
                                    innerHTML += '<tr>' +
                                                      '<input type="hidden" class="order_id" value="' + result[i].schedule[0].order_id + '" />' +
                                                      '<input type="hidden" class="sch_id" value="' + result[i].schedule[0].sch_id + '" />' +
                                                      '<td scope="row">' + count + '</td>' +
                                                      '<td>' + date + '</td>' +
                                                      '<td>' + orderid.split('.')[0] + '</td>' +
                                                      '<td><div style="width:1rem; height:1rem; background-color:' + result[i].schedule[0].sch_color + '"></div></td>' +
                                                      '<td><div class="checkbox" id="accept-' + count + '" style="font-weight:bold; color:#2e59d9;" />확정</td>' +
                                                 '</tr>';
                                } else {
                                    for(var i=0; i<result.length; i++){
                                        console.log(result[i]);
                                        // var orderid = result[i].schedule[0].order_id.toString();
                                        var orderid = result[i][0].order_id.toString();
                                        var date = result[i][0].sch_id.toString();
                                        // var date = result[i].schedule[0].sch_id.toString();
                                        var year = date.substring(3,7);
                                        var month = date.substring(7,9);
                                        var day = date.substring(9,11);
                                        date = year + '-' + month + '-' + day;
                                        var count = i+1;
                                        innerHTML += '<tr>' +
                                                          '<input type="hidden" class="order_id" value="' + result[i][0].order_id + '" />' +
                                                          '<input type="hidden" class="sch_id" value="' + result[i][0].sch_id + '" />' +
                                                          '<td scope="row">' + count + '</td>' +
                                                          '<td>' + date + '</td>' +
                                                          '<td>' + orderid.split('.')[0] + '</td>' +
                                                          '<td><div style="width:1rem; height:1rem; background-color:' + result[i][0].sch_color + '"></div></td>' +
                                                          '<td><input class="checkbox" id="accept-' + count + '" type="checkbox" checked="checked" value="Y" name="check"/></td>' +
                                                     '</tr>';
                                    }
                                }
                            }
                        } else {
                            for(var i=0; i<result.length; i++){
                                /* 추후 삭제 */
                                var orderid = result[i][0].order_id.toString();
                                /* 추후 삭제 */
                                var date = result[i][0].sch_id.toString();
                                var year = date.substring(3,7);
                                var month = date.substring(7,9);
                                var day = date.substring(9,11);
                                date = year + '-' + month + '-' + day;
                                var count = i+1;
                                innerHTML += '<tr>' +
                                                  '<input type="hidden" class="order_id" value="' + result[i][0].order_id + '" />' +
                                                  '<input type="hidden" class="sch_id" value="' + result[i][0].sch_id + '" />' +
                                                  '<td scope="row">' + count + '</td>' +
                                                  '<td>' + date + '</td>' +
                                                  '<td>' + orderid.split('.')[0] + '</td>' +
                                                  '<td><div style="width:1rem; height:1rem; background-color:' + result[i][0].sch_color + '"></div></td>' +
                                                  '<td><input class="checkbox" id="accept-' + count + '" type="checkbox" checked="checked" value="Y" name="check"/></td>' +
                                             '</tr>';
                            }
                        }
                        $('#order_body').html(innerHTML);
                    } /* data ajax */
                }).done(function(d){
                    $('input:checkbox[name="check"]').on('change', function(){
                        if($(this).val()=='Y'){
                            $(this).val('N');
                        } else {
                            $(this).val('Y');
                        }
                    })
                });
            } /* result ajax */
        });
        // ******************************************************************************************************* //
        // schedule_history
        $.ajax({
            url: "{% url 'schedule_history' %}",
            method:'GET',
            dataType: 'json',
            contentType: 'application/json',
            processData: false,
            success: function(result){
                var innerHTML='';
                for(var i=0; i<result.length; i++){
                    /* 추후 삭제 */
                    var orderid = result[i].schedule[0].order_id.toString();
                    var date = result[i].schedule[0].sch_id.toString();
                    var year = date.substring(3,7);
                    var month = date.substring(7,9);
                    var day = date.substring(9,11);
                    date = year + '-' + month + '-' + day;

                    /* 추후 삭제 */
                    var count = i+1;
                    if(result[i].use_yn == 'Y'){
                        innerHTML += '<tr>' +
                                      '<input type="hidden" class="fixed_order_id" value="' + result[i].schedule[0].order_id + '" />' +
                                      '<td scope="row">' + count + '</td>' +
                                      '<td>' + date + '</td>' +
                                      '<td>' + orderid.split('.')[0] + '</td>' +
                                      '<td><div style="width:1rem; height:1rem; background-color:' + result[i].schedule[0].sch_color + '"></div></td>' +
                                      '<td>확정</td>' +
                                 '</tr>';
                    } else {
                        innerHTML += '<tr>' +
                                      '<input type="hidden" class="fixed_order_id" value="' + result[i].schedule[0].order_id + '" />' +
                                      '<td scope="row">' + count + '</td>' +
                                      '<td>' + result[i].schedule[0].created_at + '</td>' +
                                      '<td>' + orderid.split('.')[0] + '</td>' +
                                      '<td><div style="width:1rem; height:1rem; background-color:' + result[i].schedule[0].sch_color + '"></div></td>' +
                                      '<td>미사용</td>' +
                                 '</tr>';
                    }

                }
                $('#fixed_order_body').html(innerHTML);
            }
        });
        $('#searchBtn').on('click',function(){
            doSearch(
              $('#dateFrom').val().replace(/\-/g,''),
              $('#dateTo').val().replace(/\-/g,'')
            );
        })

        function doSearch(dateFrom, dateTo){
            $.when(
               $.ajax({url: "{% url 'schedule_history' %}"})
            ).then(function(_data){
                for(var idx in _data){
                    console.log(_data);
                }
                $('#css-loader').removeClass("is-active");
            })
        }

    });
</script>
{% endblock %}